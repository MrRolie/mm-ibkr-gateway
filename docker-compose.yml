version: '3.8'

services:
  # Main application service
  app:
    build:
      context: .
      target: development
    container_name: ibkr-gateway-app
    ports:
      - "8000:8000"
    environment:
      # IBKR Connection (host.docker.internal for connecting to host machine)
      - IBKR_GATEWAY_HOST=host.docker.internal
      - PAPER_GATEWAY_PORT=4002
      - PAPER_CLIENT_ID=1
      
      # Trading Mode
      - TRADING_MODE=paper
      - ORDERS_ENABLED=false
      
      # API Server
      - API_PORT=8000
      - LOG_LEVEL=INFO
    volumes:
      # Mount source code for development (hot reload)
      - .:/app
      # Prevent overwriting node_modules or __pycache__
      - /app/.venv
      - /app/__pycache__
    networks:
      - ibkr-network
    restart: unless-stopped
    depends_on:
      - healthcheck
    extra_hosts:
      # Allow container to connect to host machine (for IBKR Gateway/TWS)
      - "host.docker.internal:host-gateway"
  
  # Healthcheck service (runs periodically)
  healthcheck:
    build:
      context: .
      target: development
    container_name: ibkr-gateway-healthcheck
    environment:
      - IBKR_GATEWAY_HOST=host.docker.internal
      - PAPER_GATEWAY_PORT=4002
      - PAPER_CLIENT_ID=2
      - TRADING_MODE=paper
      - ORDERS_ENABLED=false
    volumes:
      - .:/app
    networks:
      - ibkr-network
    command: python scripts/healthcheck.py
    restart: "no"
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # Optional: API documentation service (Swagger UI)
  docs:
    image: swaggerapi/swagger-ui:latest
    container_name: ibkr-gateway-docs
    ports:
      - "8080:8080"
    environment:
      - SWAGGER_JSON_URL=http://app:8000/openapi.json
    networks:
      - ibkr-network
    depends_on:
      - app

networks:
  ibkr-network:
    driver: bridge

# Optional: Add volumes for persistence
volumes:
  app-data:
    driver: local
